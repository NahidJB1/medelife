<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MEDeLIFE</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- DASHBOARD STYLES --- */
        .dashboard-container { padding: 2rem 5%; }
        .welcome-banner {
            background: white; padding: 2rem; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex;
            justify-content: space-between; align-items: center;
        }
        .user-info h2 { color: var(--primary-color); }
        .role-badge {
            background: var(--accent-color); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 0.9rem; text-transform: uppercase;
        }
        .logout-btn {
            background: #ff4d4d; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
        }
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-top: 30px;
        }
        .action-card {
            background: white; padding: 2rem; border-radius: 10px; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s;
        }
        .action-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .action-card i { font-size: 2.5rem; color: var(--secondary-color); margin-bottom: 15px; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 2000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 10px; width: 90%;
            max-width: 400px; position: relative; text-align: center;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;
        }
        .close-modal {
            position: absolute; top: 10px; right: 20px; font-size: 1.5rem; cursor: pointer;
        }
        /* Search Result Styling */
        .search-result {
            margin-top: 20px; padding: 15px; background: #eef7ff; 
            border: 1px solid #cce5ff; border-radius: 5px; text-align: left;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">MEDe<span class="highlight">LIFE</span></div>
        <div class="user-menu"><span id="navUserName">Loading...</span></div>
    </nav>

    <div class="dashboard-container">
        <div class="welcome-banner">
            <div class="user-info">
                <h2 id="welcomeMsg">Welcome back!</h2>
                <p>National ID: <span id="displayID">...</span></p>
                <span id="displayRole" class="role-badge">Loading Role...</span>
            </div>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>

        <div id="dashboardContent" class="dashboard-grid"></div>
    </div>

    <div id="uploadModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeUploadModal()">&times;</span>
            <h3>Upload Medical Record</h3>
            <input type="text" id="fileName" placeholder="Document Name" required>
            <select id="docType">
                <option value="prescription">Prescription</option>
                <option value="lab-report">Lab Report</option>
                <option value="x-ray">X-Ray / Scan</option>
                <option value="other">Other</option>
            </select>
            <input type="file" id="fileButton" accept=".pdf, .jpg, .png, .jpeg">
            <button onclick="uploadFile()" class="btn-primary full-width" style="width:100%; margin-top:10px;">Upload Now</button>
            <p id="uploadStatus" style="margin-top: 10px; color: #666;"></p>
        </div>
    </div>

    <div id="reportsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="text-align: left;">
            <span class="close-modal" onclick="closeReportsModal()">&times;</span>
            <h3 id="reportTitle" style="text-align: center; margin-bottom: 20px;">Medical Records</h3>
            <ul id="reportsList" style="list-style: none; padding: 0;">
                <li style="color: #666; text-align: center;">Loading...</li>
            </ul>
        </div>
    </div>

    <div id="searchModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSearchModal()">&times;</span>
            <h3>Search Patient</h3>
            <p style="color:#666; font-size: 0.9rem; margin-bottom:10px;">Enter National ID / Passport No.</p>
            <input type="text" id="searchID" placeholder="e.g. A12345678" required>
            <button onclick="searchPatient()" class="btn-primary full-width" style="width:100%;">Search</button>
            <div id="searchResultArea" style="display: none;">
                <div class="search-result">
                    <strong id="foundName">Name Here</strong><br>
                    <small id="foundRole" style="text-transform: capitalize;">Role</small>
                    <button id="viewFoundFilesBtn" class="btn-primary" style="width:100%; margin-top:10px; background-color: var(--secondary-color);">View Files</button>
                </div>
            </div>
            <p id="searchError" style="color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="journalModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="text-align: left;">
            <span class="close-modal" onclick="closeJournalModal()">&times;</span>
            <h3 style="text-align: center;">Symptom Journal</h3>
            <textarea id="journalEntry" placeholder="How are you feeling today?" style="width: 100%; height: 80px; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
            <button onclick="saveJournalEntry()" class="btn-primary full-width" style="width:100%; margin-top:10px;">Save Note</button>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <h4 style="color: var(--primary-color);">History</h4>
            <ul id="journalList" style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto;">
                <li style="color: #666; text-align: center;">Loading...</li>
            </ul>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-init.js"></script>

    <script>
        const cloudName = "dnd63lazo";      
        const uploadPreset = "medelife_upload"; 
        
        let currentUserRole = ""; // Variable to store who is logged in

        auth.onAuthStateChanged(user => {
            if (user) {
                loadUserData(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        function loadUserData(uid) {
            db.collection('users').doc(uid).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    currentUserRole = data.role; // SAVE THE ROLE!

                    document.getElementById('navUserName').innerText = data.fullName;
                    document.getElementById('welcomeMsg').innerText = "Hello, " + data.fullName;
                    document.getElementById('displayID').innerText = data.nationalID;
                    document.getElementById('displayRole').innerText = data.role;
                    loadRoleFeatures(data.role);
                }
            });
        }

        // --- ROLE BUTTONS ---
        function loadRoleFeatures(role) {
            const container = document.getElementById('dashboardContent');
            let html = '';

            if (role === 'patient') {
                html = `
                    <div class="action-card" onclick="openReportsModal()">
                        <i class="fas fa-file-medical"></i>
                        <h3>My Reports</h3>
                        <p>View lab results & prescriptions</p>
                    </div>
                    <div class="action-card" onclick="openJournalModal()">
                        <i class="fas fa-notes-medical"></i>
                        <h3>Symptom Journal</h3>
                        <p>Write notes for your doctor</p>
                    </div>
                    <div class="action-card" onclick="openUploadModal()">
                        <i class="fas fa-upload"></i>
                        <h3>Upload Documents</h3>
                        <p>Store unofficial records</p>
                    </div>
                `;
            } else if (role === 'doctor') {
                html = `
                    <div class="action-card" onclick="openSearchModal()">
                        <i class="fas fa-search"></i>
                        <h3>Search Patient</h3>
                        <p>Access full medical history</p>
                    </div>
                `;
            } else if (role === 'pharmacy') {
                html = `
                    <div class="action-card" onclick="openSearchModal()">
                        <i class="fas fa-prescription-bottle-alt"></i>
                        <h3>Verify Prescription</h3>
                        <p>Search Patient (Restricted View)</p>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // --- MODAL HELPERS ---
        function openUploadModal() { document.getElementById('uploadModal').style.display = 'flex'; }
        function closeUploadModal() { document.getElementById('uploadModal').style.display = 'none'; }
        
        function closeReportsModal() { document.getElementById('reportsModal').style.display = 'none'; }
        
        function openSearchModal() { document.getElementById('searchModal').style.display = 'flex'; }
        function closeSearchModal() { 
            document.getElementById('searchModal').style.display = 'none'; 
            document.getElementById('searchResultArea').style.display = 'none'; 
            document.getElementById('searchID').value = ''; 
        }

        function openJournalModal() {
            document.getElementById('journalModal').style.display = 'flex';
            loadJournalEntries();
        }
        function closeJournalModal() { document.getElementById('journalModal').style.display = 'none'; }

        // --- SEARCH LOGIC ---
        function searchPatient() {
            const searchInput = document.getElementById('searchID').value.trim();
            const errorMsg = document.getElementById('searchError');
            const resultArea = document.getElementById('searchResultArea');
            
            if (!searchInput) return;

            errorMsg.innerText = "Searching...";
            resultArea.style.display = 'none';

            db.collection('users').where('nationalID', '==', searchInput).get()
            .then(snapshot => {
                if (snapshot.empty) {
                    errorMsg.innerText = "No patient found with that ID.";
                } else {
                    errorMsg.innerText = "";
                    const doc = snapshot.docs[0];
                    const patientData = doc.data();
                    const patientID = doc.id;

                    document.getElementById('foundName').innerText = patientData.fullName;
                    document.getElementById('foundRole').innerText = patientData.role;
                    resultArea.style.display = 'block';

                    const viewBtn = document.getElementById('viewFoundFilesBtn');
                    viewBtn.onclick = function() {
                        openReportsModal(patientID, patientData.fullName);
                    };
                }
            })
            .catch(error => {
                console.error("Search Error:", error);
                errorMsg.innerText = "Error searching.";
            });
        }

        // --- VIEW REPORTS LOGIC (WITH PHARMACY FILTER!) ---
        function openReportsModal(targetUserID = null, targetUserName = null) {
            document.getElementById('reportsModal').style.display = 'flex';
            const list = document.getElementById('reportsList');
            const title = document.getElementById('reportTitle');
            
            list.innerHTML = '<li style="text-align: center;">Loading records...</li>';

            let uidToCheck = targetUserID;
            if (!uidToCheck) {
                uidToCheck = firebase.auth().currentUser.uid;
                title.innerText = "My Medical Records";
            } else {
                title.innerText = "Records for: " + targetUserName;
            }
            
            db.collection('users').doc(uidToCheck).collection('files')
                .orderBy('uploadedAt', 'desc')
                .get()
                .then(snapshot => {
                    list.innerHTML = "";
                    
                    let visibleCount = 0; // Count how many files we actually show

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // --- THE SECURITY FILTER ---
                        // If I am a Pharmacy, and this file is NOT a prescription -> SKIP IT
                        if (currentUserRole === 'pharmacy' && data.fileType !== 'prescription') {
                            return; 
                        }

                        visibleCount++; // We found a valid file

                        const item = `
                            <li style="background: #f9f9f9; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${data.fileName}</strong><br>
                                    <small style="color: #888;">${data.fileType}</small>
                                </div>
                                <a href="${data.fileUrl}" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: bold;">
                                    View <i class="fas fa-external-link-alt"></i>
                                </a>
                            </li>
                        `;
                        list.innerHTML += item;
                    });

                    // If no files matched the filter
                    if (visibleCount === 0) {
                        if (currentUserRole === 'pharmacy') {
                            list.innerHTML = '<li style="text-align: center;">No prescriptions found for this patient.</li>';
                        } else {
                            list.innerHTML = '<li style="text-align: center;">No documents found.</li>';
                        }
                    }
                })
                .catch(error => {
                    console.log("Error:", error);
                    list.innerHTML = `<li style="color: red;">Error: ${error.message}</li>`;
                });
        }

        // --- UPLOAD LOGIC ---
        function uploadFile() {
            const file = document.getElementById('fileButton').files[0];
            const name = document.getElementById('fileName').value;
            const type = document.getElementById('docType').value;
            const status = document.getElementById('uploadStatus');

            if (!file || !name) { alert("Please fill all fields"); return; }
            status.innerText = "Uploading...";

            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", uploadPreset);

            fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
                method: "POST", body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) throw new Error(data.error.message);
                
                status.innerText = "Saving...";
                const user = firebase.auth().currentUser;
                return db.collection('users').doc(user.uid).collection('files').add({
                    fileName: name, fileType: type, fileUrl: data.secure_url, uploadedAt: new Date()
                });
            })
            .then(() => {
                alert("Upload Success!");
                closeUploadModal();
                status.innerText = "";
            })
            .catch(err => {
                console.error(err);
                status.innerText = "Error: " + err.message;
            });
        }

        // --- JOURNAL LOGIC ---
        function saveJournalEntry() {
            const text = document.getElementById('journalEntry').value;
            if (!text) return alert("Please write something!");

            const user = firebase.auth().currentUser;
            db.collection('users').doc(user.uid).collection('journal').add({
                text: text,
                timestamp: new Date()
            }).then(() => {
                document.getElementById('journalEntry').value = ""; 
                loadJournalEntries(); 
            });
        }

        function loadJournalEntries() {
            const list = document.getElementById('journalList');
            const user = firebase.auth().currentUser;
            list.innerHTML = "<li>Loading...</li>";
            db.collection('users').doc(user.uid).collection('journal')
                .orderBy('timestamp', 'desc').get()
                .then(snapshot => {
                    list.innerHTML = "";
                    if (snapshot.empty) {
                        list.innerHTML = "<li style='text-align:center; color:#999;'>No notes yet.</li>";
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.timestamp.toDate().toLocaleDateString();
                        const time = data.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        list.innerHTML += `
                            <li style="background: #f4f4f4; padding: 10px; margin-bottom: 8px; border-radius: 5px; font-size: 0.9rem;">
                                <strong>${date} at ${time}</strong><br>${data.text}
                            </li>`;
                    });
                });
        }

        function logout() {
            auth.signOut().then(() => window.location.href = "index.html");
        }
    </script>
</body>
</html>