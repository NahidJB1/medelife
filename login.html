<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Register | MEDeLIFE</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #EF4444;       
            --primary-hover: #dc2626;
            --secondary: #22C55E;     
            --secondary-hover: #16a34a;
            --dark: #111827;
            --gray: #6B7280;
            --glass: rgba(255, 255, 255, 0.85);
            --border: rgba(255, 255, 255, 0.5);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        body {
            background: #fdf2f2;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* --- BACKGROUND ANIMATION --- */
        .bg-shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            animation: float 10s infinite alternate;
        }
        .shape-1 { width: 300px; height: 300px; background: rgba(239, 68, 68, 0.4); top: -50px; left: -50px; }
        .shape-2 { width: 400px; height: 400px; background: rgba(34, 197, 94, 0.3); bottom: -100px; right: -100px; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, 50px); } }

        /* --- GLASS CARD --- */
        .login-container {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
            position: relative;
            opacity: 0;
            animation: slideUp 0.6s ease-out forwards;
        }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        /* Close Button */
        .close-btn {
            position: absolute;
            top: 15px; right: 15px;
            color: var(--gray); font-size: 1.2rem;
            background: rgba(255,255,255,0.6);
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s; z-index: 10; text-decoration: none;
        }
        .close-btn:hover { color: var(--primary); background: white; transform: rotate(90deg); }

        .form-header { text-align: center; margin-bottom: 2rem; transition: opacity 0.3s; }
        .form-header h2 { font-size: 1.8rem; color: var(--dark); margin-bottom: 0.5rem; }
        .form-header p { color: var(--gray); font-size: 0.9rem; }

        /* --- TOGGLE BUTTONS --- */
        .toggle-btn-container {
            display: flex; background: rgba(0,0,0,0.05);
            border-radius: 50px; padding: 5px; margin-bottom: 2rem; position: relative;
        }
        .toggle-btn {
            flex: 1; border: none; background: transparent;
            padding: 10px; border-radius: 50px; cursor: pointer;
            font-weight: 600; color: var(--gray); transition: 0.3s; z-index: 1;
        }
        .toggle-btn.active { color: white; }
        
        .slider {
            position: absolute; top: 5px; left: 5px;
            height: calc(100% - 10px); width: calc(50% - 5px);
            background: var(--primary); border-radius: 50px;
            transition: 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 0; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .toggle-btn-container.register-mode .slider {
            transform: translateX(100%);
            background: var(--secondary);
            box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3);
        }

        /* --- INPUTS --- */
        .input-group { margin-bottom: 1.2rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; color: var(--dark); }
        .input-group input, .input-group select {
            width: 100%; padding: 12px 15px;
            border: 2px solid transparent; background: rgba(255, 255, 255, 0.6);
            border-radius: 12px; font-size: 0.95rem; outline: none; transition: 0.3s;
        }
        .input-group input:focus, .input-group select:focus {
            background: white; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }

        /* Error States */
        .input-group input.error { border-color: var(--primary); animation: shake 0.3s; }
        .error-msg { color: var(--primary); font-size: 0.75rem; margin-top: 4px; display: none; }
        .input-group input.error + .error-msg { display: block; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* --- BUTTONS --- */
        .btn-primary {
            width: 100%; padding: 14px;
            background: var(--primary); color: white;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: 0.3s; margin-top: 1rem;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        .btn-success { background-color: var(--secondary) !important; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3) !important; }
        .btn-success:hover { background-color: var(--secondary-hover) !important; }

        /* --- SUCCESS POPUP OVERLAY --- */
        .success-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20;
            opacity: 0; pointer-events: none; transition: 0.4s;
            transform: scale(0.9);
        }
        .success-overlay.active { opacity: 1; pointer-events: all; transform: scale(1); }

        /* Checkmark Animation */
        .checkmark-circle { width: 80px; height: 80px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .checkmark-circle i { font-size: 40px; color: white; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .success-text { font-size: 1.5rem; font-weight: 700; color: var(--dark); margin-bottom: 5px; }
        .success-sub { color: var(--gray); font-size: 0.9rem; }

        /* Helper Classes */
        .hidden { display: none; }
        .auth-form { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 480px) { .login-container { padding: 1.5rem; margin: 10px; } }
    </style>
</head>
<body class="login-body">

    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>

    <div class="login-container">
        <a href="index.html" class="close-btn"><i class="fas fa-times"></i></a>

        <div class="success-overlay" id="successOverlay">
            <div class="checkmark-circle">
                <i class="fas fa-check"></i>
            </div>
            <div class="success-text">Registration Successful!</div>
            <div class="success-sub">Log in now...</div>
        </div>

        <div class="form-header">
            <h2 id="headerTitle">Welcome Back</h2>
            <p id="headerSubtitle">Enter your details to access your records.</p>
        </div>

        <div class="toggle-btn-container" id="toggleContainer">
            <div class="slider"></div>
            <button id="loginBtn" class="toggle-btn active" onclick="switchMode('login')">Login</button>
            <button id="registerBtn" class="toggle-btn" onclick="switchMode('register')">Register</button>
        </div>

        <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
            <div class="input-group">
                <label>Email Address</label>
                <input type="email" id="loginEmail" placeholder="you@example.com" required>
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="••••••••" required>
            </div>
            <button type="submit" class="btn-primary" id="btnSignIn">Sign In</button>
            <p class="form-footer">Forgot Password? <a href="#">Reset here</a></p>
        </form>

        <form id="registerForm" class="auth-form hidden" onsubmit="handleRegister(event)">
            
            <div class="input-group">
                <label>I am a:</label>
                <select id="regRole" onchange="toggleRoleFields()" required>
                    <option value="patient">Patient</option>
                    <option value="doctor">Doctor</option>
                    <option value="pharmacy">Pharmacy Staff</option>
                </select>
            </div>

            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="regName" placeholder="Your Name" required>
                <span class="error-msg">Name cannot contain numbers or symbols.</span>
            </div>

            <div class="input-group">
                <label>National ID / Passport No.</label>
                <input type="text" id="regNationalID" placeholder="A12345678" style="text-transform: uppercase;" required>
                <span class="error-msg">Only letters and numbers allowed.</span>
            </div>
            
            <div id="doctorField" class="input-group hidden">
                <label>Medical Registration Number</label>
                <input type="text" id="regDocID" placeholder="MMC12345">
            </div>

            <div id="pharmacyField" class="input-group hidden">
                <label>Pharmacy License No.</label>
                <input type="text" id="regLicense" placeholder="L-98765">
            </div>

            <div class="input-group">
                <label>Phone Number</label>
                <input type="tel" id="regPhone" placeholder="0123456789" required>
                <span class="error-msg">Numbers only. No letters or symbols.</span>
            </div>

            <div class="input-group">
                <label>Email Address</label>
                <input type="email" id="regEmail" placeholder="email@example.com" required>
                <span class="error-msg" id="emailErrorMsg">Invalid Email</span>
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="password" id="regPassword" placeholder="Minimum 6 characters" minlength="6" required>
            </div>

            <button type="submit" class="btn-primary btn-success" id="btnRegister">Create Account</button>
        </form>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="js/firebase-init.js"></script> 
    <script>
        // --- 1. UI SWITCHING ---
        function switchMode(mode) {
            const container = document.getElementById('toggleContainer');
            const loginBtn = document.getElementById('loginBtn');
            const regBtn = document.getElementById('registerBtn');
            const loginForm = document.getElementById('loginForm');
            const regForm = document.getElementById('registerForm');
            const title = document.getElementById('headerTitle');
            const sub = document.getElementById('headerSubtitle');

            if (mode === 'register') {
                container.classList.add('register-mode');
                loginBtn.classList.remove('active');
                regBtn.classList.add('active');
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                title.innerText = "Join MEDeLIFE";
                sub.innerText = "Create a new account.";
            } else {
                container.classList.remove('register-mode');
                regBtn.classList.remove('active');
                loginBtn.classList.add('active');
                regForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                title.innerText = "Welcome Back";
                sub.innerText = "Enter your details to access your records.";
            }
        }

        function toggleRoleFields() {
            const role = document.getElementById('regRole').value;
            const docField = document.getElementById('doctorField');
            const pharmField = document.getElementById('pharmacyField');
            const docInput = document.getElementById('regDocID');
            const pharmInput = document.getElementById('regLicense');

            docField.classList.add('hidden'); pharmField.classList.add('hidden');
            docInput.required = false; pharmInput.required = false;

            if (role === 'doctor') {
                docField.classList.remove('hidden'); docInput.required = true; docField.style.animation = "fadeIn 0.5s";
            } else if (role === 'pharmacy') {
                pharmField.classList.remove('hidden'); pharmInput.required = true; pharmField.style.animation = "fadeIn 0.5s";
            }
        }

        // --- 2. REGISTRATION LOGIC ---
        function handleRegister(event) {
            event.preventDefault(); // Stop page reload immediately

            const btn = document.getElementById('btnRegister');
            const originalText = btn.innerText;
            const emailInput = document.getElementById('regEmail');
            const passwordInput = document.getElementById('regPassword');
            const emailErrorMsg = document.getElementById('emailErrorMsg');

            // 1. DISABLE BUTTON IMMEDIATELY (Prevents double clicks/errors)
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

            // 2. Client-Side Validation
            if (!validateInputs()) {
                // If invalid, re-enable button and stop
                btn.disabled = false;
                btn.innerText = originalText;
                return;
            }

            // 3. Attempt Firebase Creation
            // We assume 'firebase' is available from your script tags
            if (typeof firebase !== 'undefined') {
                firebase.auth().createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
                .then((userCredential) => {
        // --- SUCCESS ---
        
        // <--- ADD THESE 3 LINES HERE --->
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userName', document.getElementById('regName').value);
        localStorage.setItem('userRole', document.getElementById('regRole').value);
        // <--- END ADD --->

        showSuccessAnimation();
                    // Optional: Save other user details to Firestore here
                })
                .catch((error) => {
                    // --- ERROR HANDLING ---
                    btn.disabled = false;
                    btn.innerText = originalText;
                    
                    if (error.code === 'auth/email-already-in-use') {
                        // Custom nice error on the input, NOT an alert
                        emailInput.classList.add('error');
                        emailErrorMsg.innerText = "This email is already registered. Try logging in.";
                        emailErrorMsg.style.display = "block";
                    } else if (error.code === 'auth/weak-password') {
                        alert("Password is too weak. Please use a stronger password.");
                    } else {
                        console.error(error);
                        alert("Error: " + error.message);
                    }
                });
            } else {
                // Fallback if Firebase isn't loaded (For Demo purposes)
                setTimeout(() => { showSuccessAnimation(); }, 1500);
            }
        }

        function showSuccessAnimation() {
            // Hide the form
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('headerTitle').style.opacity = '0';
            document.getElementById('headerSubtitle').style.opacity = '0';
            
            // Show the nice popup
            const overlay = document.getElementById('successOverlay');
            overlay.classList.add('active');

            // Wait 2.5 seconds, then switch to Login view
            setTimeout(() => {
                overlay.classList.remove('active');
                document.getElementById('headerTitle').style.opacity = '1';
                document.getElementById('headerSubtitle').style.opacity = '1';
                
                // Reset Form
                document.getElementById('registerForm').reset();
                document.getElementById('btnRegister').disabled = false;
                document.getElementById('btnRegister').innerText = "Create Account";
                
                // Switch View
                switchMode('login');
            }, 2500);
        }

        function validateInputs() {
            const nameRegex = /^[a-zA-Z\s]+$/;
            const idRegex = /^[a-zA-Z0-9]+$/;
            const phoneRegex = /^[0-9]+$/;

            const nameInput = document.getElementById('regName');
            const idInput = document.getElementById('regNationalID');
            const phoneInput = document.getElementById('regPhone');
            
            let isValid = true;

            if (!nameRegex.test(nameInput.value)) { setError(nameInput); isValid = false; } else { clearError(nameInput); }
            if (!idRegex.test(idInput.value)) { setError(idInput); isValid = false; } else { clearError(idInput); }
            if (!phoneRegex.test(phoneInput.value)) { setError(phoneInput); isValid = false; } else { clearError(phoneInput); }

            return isValid;
        }

        function setError(inputElement) {
            inputElement.classList.add('error');
            setTimeout(() => { inputElement.classList.remove('error'); inputElement.style.borderColor = "#EF4444"; }, 300);
        }
        function clearError(inputElement) { inputElement.style.borderColor = "transparent"; document.getElementById('emailErrorMsg').style.display = 'none'; }
        
        // --- LOGIN HANDLER (FIXED) ---
        function handleLogin(event) {
    event.preventDefault();
    const btn = document.getElementById('btnSignIn');
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';

    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    if (typeof firebase !== 'undefined') {
        firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // --- SUCCESS ---
            localStorage.setItem('isLoggedIn', 'true');
            
            // Save Name if missing
            if(!localStorage.getItem('userName')) {
                localStorage.setItem('userName', email.split('@')[0]);
            }

            // --- UPDATE: Redirect to Dashboard ---
            window.location.href = "dashboard.html"; 
        })
        .catch((error) => {
            btn.disabled = false;
            btn.innerText = originalText;
            alert("Login Failed: " + error.message);
        });
    } else {
        // --- DEMO FALLBACK ---
        setTimeout(() => { 
            localStorage.setItem('isLoggedIn', 'true');
            if(!localStorage.getItem('userName')) {
                localStorage.setItem('userName', email.split('@')[0]);
            }
            // --- UPDATE: Redirect to Dashboard ---
            window.location.href = "dashboard.html"; 
        }, 1500);
    }
}
    </script>
</body>
</html>s
