<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Feed | MEDeLIFE</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #EF4444;
            --primary-hover: #dc2626;
            --secondary: #22C55E;
            --dark: #111827;
            --gray: #6B7280;
            --light: #F3F4F6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body {
            background-color: #F9FAFB;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* --- NAVBAR --- */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 5%; position: fixed; width: 100%; top: 0; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .logo-container { display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .nav-links { display: flex; gap: 2rem; list-style: none; }
        .nav-links a { color: var(--gray); font-weight: 500; text-decoration: none; transition: 0.3s; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary); }
        
        /* --- LAYOUT --- */
        .main-container {
            max-width: 900px; margin: 100px auto 0;
            display: grid; grid-template-columns: 1fr 320px; 
            gap: 2rem; padding: 0 20px 40px;
        }

        /* --- FEED SECTION --- */
        .feed { display: flex; flex-direction: column; gap: 1.5rem; }

        /* Create Post Card */
        .create-post-card {
            background: white; border-radius: 16px; padding: 1.5rem;
            box-shadow: var(--shadow); border: 1px solid #E5E7EB;
        }

        .cp-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 1rem; }
        .cp-tab {
            padding: 10px 20px; cursor: pointer; font-weight: 600; color: var(--gray);
            border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .cp-tab:hover { color: var(--primary); }
        .cp-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .cp-tab.hidden { display: none; }

        .input-area { display: flex; flex-direction: column; gap: 10px; }
        
        .post-title-input {
            width: 100%; border: 1px solid #E5E7EB; padding: 10px 15px;
            border-radius: 8px; font-weight: 600; font-size: 1rem; outline: none;
            display: none; /* Hidden by default (for questions) */
        }
        .post-title-input.active { display: block; }

        textarea {
            width: 100%; border: none; resize: none; outline: none;
            font-size: 1rem; padding: 10px 0; min-height: 80px;
            font-family: 'Poppins', sans-serif;
        }

        .cp-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;
        }
        .btn-post {
            background: var(--primary); color: white; padding: 8px 25px;
            border-radius: 50px; border: none; font-weight: 600;
            cursor: pointer; transition: 0.3s;
        }
        .btn-post:hover { background: var(--primary-hover); }

        /* --- POST CARD --- */
        .post-card {
            background: white; border-radius: 16px; padding: 1.5rem;
            box-shadow: var(--shadow); animation: fadeUp 0.5s ease-out;
            border: 1px solid #E5E7EB;
        }
        
        /* Post Header */
        .post-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .user-info { display: flex; gap: 12px; align-items: center; }
        .avatar {
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--light);
        }
        .meta h4 { font-size: 1rem; font-weight: 600; line-height: 1.2; }
        .meta span { font-size: 0.8rem; color: var(--gray); }
        
        .role-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        .role-patient { background: #E0F2FE; color: #0284C7; }
        .role-pharmacy { background: #F3E8FF; color: #9333EA; }
        .role-doctor { background: #DCFCE7; color: #16A34A; }

        /* Post Content */
        .post-content h3 { font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--dark); }
        .post-content p { color: #374151; line-height: 1.6; font-size: 0.95rem; white-space: pre-line; }
        .post-tag { 
            display: inline-block; background: #FEF2F2; color: var(--primary); 
            font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; margin-bottom: 8px; font-weight: 600;
        }

        /* Interaction Bar */
        .interaction-bar {
            display: flex; gap: 1.5rem; margin-top: 1rem; padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        .action-btn {
            background: none; border: none; color: var(--gray);
            cursor: pointer; display: flex; align-items: center; gap: 6px;
            font-size: 0.9rem; transition: 0.2s;
        }
        .action-btn:hover { color: var(--dark); }
        .action-btn.liked { color: var(--primary); }
        .action-btn.liked i { font-weight: 900; }

        /* Comments Section */
        .comments-section {
            margin-top: 1rem; background: #F9FAFB; padding: 1rem;
            border-radius: 12px; display: none; /* Hidden by default */
        }
        .comments-section.open { display: block; animation: fadeIn 0.3s; }
        
        .comment-input-box { display: flex; gap: 10px; margin-bottom: 15px; }
        .comment-input-box input {
            flex: 1; padding: 8px 12px; border: 1px solid #E5E7EB;
            border-radius: 20px; outline: none; font-size: 0.9rem;
        }
        .btn-send {
            background: var(--dark); color: white; border: none;
            width: 35px; height: 35px; border-radius: 50%; cursor: pointer;
        }

        .comment-list { display: flex; flex-direction: column; gap: 10px; }
        .single-comment { font-size: 0.9rem; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .comment-author { font-weight: 600; font-size: 0.85rem; margin-right: 5px; }

        /* --- WIDGETS --- */
        .widget {
            background: white; padding: 1.5rem; border-radius: 16px;
            box-shadow: var(--shadow); margin-bottom: 1.5rem; height: fit-content;
        }
        .widget h3 { font-size: 1.1rem; margin-bottom: 1rem; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        .topic-tag {
            display: inline-block; background: #F3F4F6; padding: 5px 12px;
            border-radius: 50px; font-size: 0.85rem; color: var(--dark);
            margin: 0 5px 8px 0; cursor: pointer; transition: 0.3s;
        }
        .topic-tag:hover { background: #e5e7eb; }

        /* --- TOAST --- */
        #toast-box {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--dark); color: white; padding: 15px 25px;
            border-radius: 12px; z-index: 9999; opacity: 0; transform: translateY(20px);
            transition: all 0.3s ease; pointer-events: none;
            display: flex; align-items: center; gap: 10px;
        }
        #toast-box.show { opacity: 1; transform: translateY(0); }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar-right { display: none; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="logo-container">
            <svg width="35" height="35" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <rect x="35" y="10" width="30" height="80" rx="5" fill="#EF4444" />
                <rect x="10" y="35" width="80" height="30" rx="5" fill="#EF4444" />
            </svg>
            <div style="font-family: 'Poppins', sans-serif; font-size: 20px; font-weight: 700; line-height: 1;">
                <span style="color: #EF4444;">MED</span><span style="color: #000;">e</span><span style="color: #22C55E;">LIFE</span>
            </div>
        </a>
        <ul class="nav-links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="#" class="active">Community</a></li>
            <li><a href="dashboard.html" onclick="localStorage.setItem('openProfile','true')">Profile</a></li>
        </ul>
    </nav>

    <div class="main-container">

        <main class="feed">

            <div class="create-post-card">
                <div class="cp-tabs">
                    <div class="cp-tab active" onclick="setPostType('question')">Ask Question</div>
                    <div class="cp-tab hidden" id="tabArticle" onclick="setPostType('article')">Write Article</div>
                </div>
                
                <div class="input-area">
                    <input type="text" id="postTitle" class="post-title-input" placeholder="Article Headline...">
                    <textarea id="postContent" placeholder="What health question is on your mind?"></textarea>
                </div>

                <div class="cp-footer">
                    <small style="color:var(--gray)">Be respectful. Medical advice here is not a substitute for professional care.</small>
                    <button class="btn-post" onclick="submitPost()">Post</button>
                </div>
            </div>

            <div id="feedContainer">
                <div style="text-align:center; padding:40px; color:gray;">
                    <i class="fas fa-spinner fa-spin"></i> Loading community...
                </div>
            </div>

        </main>

        <aside class="sidebar-right">
            <div class="widget">
                <h3>Trending Topics</h3>
                <div>
                    <span class="topic-tag">#FluSeason</span>
                    <span class="topic-tag">#MentalHealth</span>
                    <span class="topic-tag">#DietTips</span>
                    <span class="topic-tag">#VaccineInfo</span>
                    <span class="topic-tag">#Diabetes</span>
                </div>
            </div>

            <div class="widget">
                <h3>Community Guidelines</h3>
                <ul style="padding-left: 20px; color: var(--gray); font-size: 0.9rem; line-height: 1.8;">
                    <li>Respect patient privacy.</li>
                    <li>No hate speech or bullying.</li>
                    <li>Doctors must verify identity.</li>
                    <li>Report suspicious content.</li>
                </ul>
            </div>
        </aside>

    </div>

    <div id="toast-box"><i class="fas fa-info-circle"></i> <span id="toast-msg">Notification</span></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-init.js"></script>

    <script>
        // --- 1. SETUP ---
        const db = firebase.firestore();
        let currentUser = null;
        let currentPostType = 'question';

        document.addEventListener("DOMContentLoaded", () => {
            initCommunity();
        });

        function initCommunity() {
            // Check LocalStorage for basic User Data (Fast Load)
            const role = localStorage.getItem('userRole') || 'patient';
            const name = localStorage.getItem('userName') || 'User';
            const uid = localStorage.getItem('userUid'); // Ensure Dashboard saves this

            if (!localStorage.getItem('isLoggedIn')) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = { name, role, uid };

            // UI Adaptation based on Role
            if (role === 'doctor') {
                document.getElementById('tabArticle').classList.remove('hidden');
            }

            // Load Posts
            listenToPosts();
        }

        // --- 2. POSTING LOGIC ---
        function setPostType(type) {
            currentPostType = type;
            const titleInput = document.getElementById('postTitle');
            const contentInput = document.getElementById('postContent');
            const tabs = document.querySelectorAll('.cp-tab');

            tabs.forEach(t => t.classList.remove('active'));
            
            if (type === 'article') {
                document.getElementById('tabArticle').classList.add('active');
                titleInput.classList.add('active');
                contentInput.placeholder = "Write your medical article content here...";
                contentInput.rows = 6;
            } else {
                tabs[0].classList.add('active');
                titleInput.classList.remove('active');
                contentInput.placeholder = "What health question is on your mind?";
                contentInput.rows = 3;
            }
        }

        function submitPost() {
            const content = document.getElementById('postContent').value.trim();
            const title = document.getElementById('postTitle').value.trim();

            if (!content) { showToast("Please write something!"); return; }
            if (currentPostType === 'article' && !title) { showToast("Articles need a title."); return; }

            const postData = {
                authorName: currentUser.name,
                authorRole: currentUser.role,
                authorId: currentUser.uid,
                content: content,
                title: currentPostType === 'article' ? title : null,
                type: currentPostType,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                likes: [], // Array of UIDs
                comments: [] // Simple array of objects for this demo
            };

            db.collection('posts').add(postData).then(() => {
                document.getElementById('postContent').value = '';
                document.getElementById('postTitle').value = '';
                showToast("Post published!");
                // Reset to Question mode
                setPostType('question'); 
            }).catch(err => console.error(err));
        }

        // --- 3. RENDERING FEED ---
        function listenToPosts() {
            db.collection('posts').orderBy('timestamp', 'desc').limit(20)
                .onSnapshot(snapshot => {
                    const feed = document.getElementById('feedContainer');
                    feed.innerHTML = '';

                    if(snapshot.empty) {
                        feed.innerHTML = '<div style="text-align:center; padding:20px;">No posts yet. Be the first!</div>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const post = doc.data();
                        const postId = doc.id;
                        
                        // Check if Liked by current user
                        const isLiked = post.likes && post.likes.includes(currentUser.uid);
                        const likeCount = post.likes ? post.likes.length : 0;
                        const commentCount = post.comments ? post.comments.length : 0;

                        // Badge Color
                        let badgeClass = 'role-patient';
                        if(post.authorRole === 'doctor') badgeClass = 'role-doctor';
                        if(post.authorRole === 'pharmacy') badgeClass = 'role-pharmacy';

                        // Tag Label
                        let tagLabel = post.type === 'article' ? '<span class="post-tag">Article</span>' : '<span class="post-tag" style="background:#E0F2FE; color:#0284C7">Question</span>';

                        // Title HTML (only if article)
                        let titleHtml = post.title ? `<h3>${post.title}</h3>` : '';

                        // Render Card
                        const div = document.createElement('div');
                        div.className = 'post-card';
                        div.innerHTML = `
                            <div class="post-header">
                                <div class="user-info">
                                    <div class="avatar" style="background:#eee; display:flex; align-items:center; justify-content:center; font-size:1.2rem; color:#aaa;">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="meta">
                                        <h4>${post.authorName} <span class="role-badge ${badgeClass}">${post.authorRole.toUpperCase()}</span></h4>
                                        <span>${formatDate(post.timestamp)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="post-content">
                                ${tagLabel}
                                ${titleHtml}
                                <p>${post.content}</p>
                            </div>

                            <div class="interaction-bar">
                                <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${postId}', ${isLiked})">
                                    <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${likeCount} Likes
                                </button>
                                <button class="action-btn" onclick="toggleComments('${postId}')">
                                    <i class="far fa-comment"></i> ${commentCount} Comments
                                </button>
                            </div>

                            <div id="comments-${postId}" class="comments-section">
                                <div class="comment-input-box">
                                    <input type="text" id="input-${postId}" placeholder="Write a comment...">
                                    <button class="btn-send" onclick="submitComment('${postId}')"><i class="fas fa-paper-plane"></i></button>
                                </div>
                                <div class="comment-list" id="list-${postId}">
                                    ${renderComments(post.comments)}
                                </div>
                            </div>
                        `;
                        feed.appendChild(div);
                    });
                });
        }

        // --- 4. INTERACTIONS ---
        
        function toggleLike(postId, isLiked) {
            const postRef = db.collection('posts').doc(postId);
            if (isLiked) {
                postRef.update({
                    likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });
            } else {
                postRef.update({
                    likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            }
        }

        function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            section.classList.toggle('open');
        }

        function submitComment(postId) {
            const input = document.getElementById(`input-${postId}`);
            const text = input.value.trim();
            if (!text) return;

            const newComment = {
                text: text,
                author: currentUser.name,
                role: currentUser.role,
                timestamp: new Date().toISOString()
            };

            db.collection('posts').doc(postId).update({
                comments: firebase.firestore.FieldValue.arrayUnion(newComment)
            }).then(() => {
                input.value = ''; // Clear input
            });
        }

        function renderComments(commentsArray) {
            if (!commentsArray || commentsArray.length === 0) return '<div style="color:#9CA3AF; font-size:0.85rem;">No comments yet.</div>';
            
            return commentsArray.map(c => {
                let color = c.role === 'doctor' ? 'var(--secondary)' : 'var(--dark)';
                return `
                    <div class="single-comment">
                        <span class="comment-author" style="color:${color}">${c.author}:</span>
                        <span>${c.text}</span>
                    </div>
                `;
            }).join('');
        }

        // --- 5. UTILITIES ---
        function formatDate(timestamp) {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate();
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function showToast(msg) {
            const box = document.getElementById('toast-box');
            document.getElementById('toast-msg').innerText = msg;
            box.classList.add('show');
            setTimeout(() => box.classList.remove('show'), 3000);
        }

    </script>
</body>
</html>