<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDeLIFE | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- SHARED VARIABLES --- */
        :root {
            --primary: #EF4444;       
            --secondary: #22C55E;     
            --dark: #111827;          
            --gray: #6B7280;          
            --light: #F3F4F6;         
            --white: #ffffff;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #F9FAFB; color: var(--dark); display: flex; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); height: 100vh; background: var(--white);
            position: fixed; top: 0; left: 0; border-right: 1px solid #E5E7EB;
            display: flex; flex-direction: column; padding: 2rem 1.5rem;
            transition: all 0.3s ease; z-index: 100;
        }
        .brand {
            font-size: 24px; font-weight: 700; margin-bottom: 3rem; display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .nav-items { flex: 1; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item {
            padding: 12px 15px; border-radius: 12px; color: var(--gray);
            font-weight: 500; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover, .nav-item.active { background: #FEF2F2; color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        
        .user-mini-profile {
            border-top: 1px solid #E5E7EB; padding-top: 1.5rem; display: flex; align-items: center; gap: 12px;
        }
        .mini-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--secondary); }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width));
            padding: 2rem 3rem; min-height: 100vh;
        }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
        .welcome-text h1 { font-size: 1.8rem; margin-bottom: 5px; animation: slideDown 0.5s ease-out; }
        .welcome-text p { color: var(--gray); animation: slideDown 0.7s ease-out; }
        
        .header-actions { display: flex; gap: 1rem; }
        .btn-logout { 
            padding: 10px 20px; border: 2px solid #FEE2E2; color: var(--primary); 
            background: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; 
        }
        .btn-logout:hover { background: #FEE2E2; }

        /* Dashboard Cards */
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 1.5rem; margin-bottom: 2.5rem; 
        }
        .stat-card {
            background: white; padding: 1.5rem; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #E5E7EB;
            display: flex; align-items: center; gap: 1.5rem;
            animation: fadeIn 0.8s ease-out backwards;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--secondary); }
        
        .icon-box { 
            width: 60px; height: 60px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .icon-patient { background: #DCFCE7; color: var(--secondary); }
        .icon-doc { background: #FEE2E2; color: var(--primary); }
        .icon-pharmacy { background: #E0E7FF; color: #4F46E5; }
        
        .stat-info h3 { font-size: 2rem; font-weight: 700; line-height: 1.2; }
        .stat-info p { color: var(--gray); font-size: 0.9rem; }

        /* Actions */
        .action-section { margin-bottom: 2rem; animation: slideUp 1s ease-out backwards; }
        .section-title { font-size: 1.2rem; margin-bottom: 1rem; font-weight: 600; }
        
        .quick-actions { display: flex; gap: 1rem; flex-wrap: wrap; }
        .action-card {
            flex: 1; min-width: 200px; background: white; padding: 2rem;
            border-radius: 16px; text-align: center; cursor: pointer;
            border: 2px dashed #E5E7EB; transition: all 0.3s;
        }
        .action-card:hover { border-color: var(--primary); background: #FEF2F2; }
        .action-card i { font-size: 2rem; color: var(--primary); margin-bottom: 1rem; }
        .action-card h4 { margin-bottom: 0.5rem; }
        .action-card p { font-size: 0.85rem; color: var(--gray); }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            z-index: 2000; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        
        .dashboard-modal {
            background: white; width: 90%; max-width: 600px;
            border-radius: 16px; padding: 2rem; position: relative;
            max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            position: absolute; top: 15px; right: 20px; font-size: 1.5rem;
            cursor: pointer; color: var(--gray);
            z-index: 10;
        }
        
        /* List Items */
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border: 1px solid #E5E7EB; border-radius: 10px;
            margin-bottom: 10px; transition: 0.2s;
        }
        .list-item:hover { border-color: var(--primary); background: #FEF2F2; }
        
        .list-btn {
            padding: 8px 16px; border-radius: 6px; border: none; 
            font-weight: 600; cursor: pointer; font-size: 0.85rem;
        }
        .btn-book { background: var(--primary); color: white; }
        .btn-view { background: #4F46E5; color: white; }
        .btn-accept { background: var(--secondary); color: white; margin-right: 5px;}
        .btn-decline { background: var(--primary); color: white; }
        .btn-cancel { background: #9CA3AF; color: white; margin-left: 5px; }

        /* Form Elements & New Redesigned Bars */
        .modal-form label { display: block; margin-bottom: 8px; font-weight: 500; }
        .modal-form select, .modal-form input:not([type="file"]), .modal-form textarea {
            width: 100%; padding: 12px; border: 1px solid #E5E7EB; 
            border-radius: 12px; margin-bottom: 15px; outline: none;
            font-family: 'Poppins', sans-serif;
        }
        .modal-form input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1); }

        /* --- REDESIGN: Modern Upload Area (Patient) --- */
        .modern-upload-box {
            border: 2px dashed #E5E7EB; border-radius: 16px;
            padding: 40px 20px; text-align: center;
            background: #F9FAFB; cursor: pointer;
            transition: all 0.3s ease; position: relative;
            margin-bottom: 20px;
        }
        .modern-upload-box:hover {
            border-color: var(--primary); background: #FEF2F2;
        }
        .modern-upload-box i {
            font-size: 3rem; color: #9CA3AF; margin-bottom: 15px; transition: 0.3s;
        }
        .modern-upload-box:hover i { color: var(--primary); transform: scale(1.1); }
        .modern-upload-box p { font-weight: 500; color: #4B5563; }
        .modern-upload-box small { color: #9CA3AF; display: block; margin-top: 5px; }
        
        /* The file input is hidden but covers the box */
        .file-input-hidden {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }
        .file-name-display {
            display: inline-block; margin-top: 10px;
            padding: 5px 12px; background: white; border-radius: 20px;
            font-size: 0.85rem; color: var(--primary);
            border: 1px solid #FEE2E2; font-weight: 600;
        }

        /* --- REDESIGN: Modern Search Bar (Doc/Pharmacy) --- */
        .modern-search-bar {
            position: relative; width: 100%; margin-bottom: 25px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 50px; background: white;
            display: flex; align-items: center; padding: 5px;
            border: 1px solid transparent; transition: 0.3s;
        }
        .modern-search-bar:focus-within {
            border-color: var(--primary); box-shadow: 0 10px 25px -5px rgba(239, 68, 68, 0.2);
        }
        .search-icon {
            padding-left: 20px; color: #9CA3AF; font-size: 1.2rem;
        }
        .search-input-field {
            flex: 1; border: none; padding: 15px;
            font-size: 1rem; border-radius: 50px; outline: none;
            background: transparent; /* FIXED: Transparent background to avoid pill-in-pill look */
        }
        .search-btn-modern {
            background: var(--dark); color: white; border: none;
            padding: 12px 25px; border-radius: 40px;
            font-weight: 600; cursor: pointer; transition: 0.3s;
            margin-right: 5px;
        }
        .search-btn-modern:hover { background: var(--primary); transform: translateX(-2px); }


        /* Animations */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; padding: 1.5rem; }
        }

        /* --- Add this to your existing CSS --- */
.btn-time {
    background: #F59E0B; /* Amber color */
    color: white;
    margin-right: 5px;
    padding: 8px 12px; /* Slightly different padding for icon */
}
.btn-time:hover { background: #D97706; }


    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="brand" onclick="window.location.href='index.html'">
            <svg width="30" height="30" viewBox="0 0 100 100" style="margin-right: 10px;">
                <rect x="35" y="10" width="30" height="80" rx="5" fill="#EF4444" />
                <rect x="10" y="35" width="80" height="30" rx="5" fill="#EF4444" />
            </svg>
            <span>MED<span style="color:var(--secondary)">e</span>LIFE</span>
        </div>

        <div class="nav-items" id="sidebarNav"></div>

        <div class="user-mini-profile">
            <img id="sideAvatar" src="https://via.placeholder.com/150" class="mini-avatar">
            <div>
                <h4 id="sideName" style="font-size: 0.9rem;">Loading...</h4>
                <p id="sideRole" style="font-size: 0.75rem; color: var(--gray);">...</p>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header>
            <div class="welcome-text">
                <h1 id="welcomeTitle">Welcome Back!</h1>
                <p id="currentDate">Loading date...</p>
            </div>
            <div class="header-actions">
                <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <div class="stats-grid" id="statsGrid"></div>

        <div class="action-section">
            <div class="section-title" id="actionTitle">Quick Actions</div>
            <div class="quick-actions" id="actionGrid"></div>
        </div>
    </main>

    <div class="modal-overlay" id="dashboardModal">
        <div class="dashboard-modal">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="js/firebase-init.js"></script>

    <script>
    // --- 0. FIREBASE SETUP ---
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUserData = null;
    const modal = document.getElementById('dashboardModal');
    const modalContent = document.getElementById('modalContent');

    // --- 1. INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
        initDashboard();
    });

    async function initDashboard() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (!isLoggedIn) { window.location.href = 'index.html'; return; }

        const role = localStorage.getItem('userRole') || 'patient';
        const name = localStorage.getItem('userName') || 'User';

        let storedUid = localStorage.getItem('userUid');
        if (!storedUid) {
            storedUid = 'user_' + Math.floor(Math.random() * 1000000);
            localStorage.setItem('userUid', storedUid);
        }

        currentUserData = {
            name: name,
            role: role,
            uid: storedUid
        };

        // UI Header
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', options);
        document.getElementById('welcomeTitle').innerHTML = `Welcome back, <span style="color: var(--primary)">${name}</span>`;
        document.getElementById('sideName').innerText = name;
        document.getElementById('sideRole').innerText = role.toUpperCase();

        const savedJSON = localStorage.getItem('userProfileData');
        if (savedJSON) {
            const data = JSON.parse(savedJSON);
            if (data.photo) document.getElementById('sideAvatar').src = data.photo;
        }

        // --- SYNC ID WITH DB ---
        await syncUserWithDB();

        // ROUTING
        if (role === 'doctor') renderDoctorView();
        else if (role === 'pharmacy') renderPharmacyView();
        else renderPatientView();
    }

    // --- 2. PATIENT VIEW ---
    // --- 2. PATIENT VIEW ---
function renderPatientView() {
    document.getElementById('sidebarNav').innerHTML = `
        <div class="nav-item active"><i class="fas fa-home"></i> Home</div>
        <div class="nav-item"><i class="fas fa-history"></i> Medical History</div>
        <div class="nav-item"><i class="fas fa-pills"></i> Prescriptions</div>
    `;

    document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
            <div class="icon-box icon-patient"><i class="fas fa-heartbeat"></i></div>
            <div class="stat-info"><h3>Healthy</h3><p>Status</p></div>
        </div>
        <div class="stat-card">
            <div class="icon-box icon-doc"><i class="fas fa-file-medical-alt"></i></div>
            <div class="stat-info"><h3>Check</h3><p>My Reports</p></div>
        </div>
    `;

    document.getElementById('actionGrid').innerHTML = `
        <div class="action-card" onclick="openUploadModal()">
            <i class="fas fa-file-upload"></i>
            <h4>Upload Report</h4>
            <p>X-Ray, ECG, etc.</p>
        </div>
        <div class="action-card" onclick="openFindDoctorModal()">
            <i class="fas fa-user-md"></i>
            <h4>Find Doctors</h4>
            <p>Book Appointment</p>
        </div>
        <div class="action-card" onclick="openPatientSchedule()">
            <i class="fas fa-calendar-alt"></i>
            <h4>View Schedule</h4>
            <p>Check Appointments</p>
        </div>
        <div class="action-card" onclick="openMyReports()">
            <i class="fas fa-file-medical-alt"></i>
            <h4>My Reports</h4>
            <p>View History</p>
        </div>
    `;
}

    // --- 3. DOCTOR VIEW ---
    function renderDoctorView() {
        document.getElementById('sidebarNav').innerHTML = `
            <div class="nav-item active"><i class="fas fa-th-large"></i> Dashboard</div>
            <div class="nav-item"><i class="fas fa-user-injured"></i> My Patients</div>
        `;

        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card" onclick="openAppointmentList('pending')">
                <div class="icon-box icon-doc"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-info"><h3>Check</h3><p>Requests</p></div>
            </div>
        `;

        document.getElementById('actionGrid').innerHTML = `
            <div class="action-card" onclick="openAppointmentList('accepted')">
                <i class="fas fa-clipboard-list"></i>
                <h4>View Bookings</h4>
                <p>Confirmed Patients</p>
            </div>
            <div class="action-card" onclick="openPatientSearch()">
                <i class="fas fa-user-injured"></i>
                <h4>Find Patient</h4>
                <p>View History & Prescribe</p>
            </div>
        `;
    }

    // --- 4. PHARMACY VIEW ---
    function renderPharmacyView() {
        document.getElementById('sidebarNav').innerHTML = `
            <div class="nav-item active"><i class="fas fa-clinic-medical"></i> Dashboard</div>
            <div class="nav-item"><i class="fas fa-search"></i> Patient Lookup</div>
        `;

        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <div class="icon-box icon-pharmacy"><i class="fas fa-prescription-bottle"></i></div>
                <div class="stat-info"><h3>Rx</h3><p>Dispense</p></div>
            </div>
        `;

        document.getElementById('actionGrid').innerHTML = `
            <div class="action-card" onclick="openPatientSearch()">
                <i class="fas fa-search"></i>
                <h4>Search Patient</h4>
                <p>View Prescriptions</p>
            </div>
        `;
    }

    // ==========================================
    //        LOGIC FUNCTIONS (MODALS)
    // ==========================================

    function closeModal() {
        modal.classList.remove('active');
    }

    // --- A. PATIENT: UPLOAD REPORT (REDESIGNED) ---
    function openUploadModal() {
        modalContent.innerHTML = `
            <h2 style="margin-bottom:20px;">Upload Document</h2>
            <div class="modal-form">
                <label>Type of Document</label>
                <select id="reportType">
                    <option value="X-Ray">X-Ray / Scan</option>
                    <option value="ECG">ECG Report</option>
                    <option value="Blood Test">Blood / Lab Test</option>
                    <option value="Prescription">Old Prescription</option>
                </select>
                
                <div class="modern-upload-box">
                    <input type="file" id="reportFile" class="file-input-hidden" accept="image/*,.pdf" onchange="updateFileDisplay(this)">
                    <div id="uploadContentUi">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click or Drag file here to upload</p>
                        <small>Supports: PDF, JPG, PNG</small>
                    </div>
                </div>

                <div id="fileSelectedName" style="text-align:center; margin-bottom:15px; display:none;">
                    <span class="file-name-display" id="fNameText"></span>
                </div>

                <button class="list-btn btn-book" id="btn-upload-action" style="width:100%; padding:15px; font-size:1rem;" onclick="submitReport()">
                    <i class="fas fa-check"></i> Submit Report
                </button>
            </div>
        `;
        modal.classList.add('active');
    }

    // Helper for the new design to show filename
    function updateFileDisplay(input) {
        const display = document.getElementById('fNameText');
        const wrapper = document.getElementById('fileSelectedName');
        if(input.files && input.files[0]) {
            display.innerText = input.files[0].name;
            wrapper.style.display = 'block';
            document.querySelector('.modern-upload-box').style.borderColor = 'var(--secondary)';
            document.querySelector('.modern-upload-box i').style.color = 'var(--secondary)';
            document.querySelector('.modern-upload-box i').className = 'fas fa-file-check';
        }
    }

    function submitReport() {
        const type = document.getElementById('reportType').value;
        const fileInput = document.getElementById('reportFile');
        const btn = document.getElementById('btn-upload-action');

        if (fileInput.files.length === 0) { alert("Please select a file."); return; }

        btn.innerText = "Uploading...";
        btn.disabled = true;

        const reader = new FileReader();
        reader.readAsDataURL(fileInput.files[0]);
        reader.onload = function () {
            const base64String = reader.result;
            db.collection('reports').add({
                patientId: currentUserData.uid,
                patientName: currentUserData.name,
                reportType: type,
                fileData: base64String,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                // FIXED: Removed success alert as requested
                closeModal();
            }).catch(err => {
                alert("Error: " + err.message);
                btn.innerText = "Submit Report";
                btn.disabled = false;
            });
        };
    }

    // --- B. PATIENT: MY REPORTS ---
    function openMyReports() {
        modalContent.innerHTML = `<h2>My Medical Reports</h2><div id="myReportList" style="margin-top:15px">Loading your reports...</div>`;
        modal.classList.add('active');

        db.collection('reports')
            .where('patientId', '==', currentUserData.uid)
            .get()
            .then(snap => {
                const list = document.getElementById('myReportList');
                list.innerHTML = ''; 

                if (snap.empty) {
                    list.innerHTML = `
                    <div style="text-align:center; color:gray; padding:20px;">
                        <i class="fas fa-folder-open" style="font-size:40px; margin-bottom:10px;"></i>
                        <p>No reports found.</p>
                    </div>`;
                    return;
                }

                snap.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    
                    div.innerHTML = `
                        <div>
                            <strong>${data.reportType}</strong><br>
                            <small>${new Date().toLocaleDateString()}</small>
                        </div>
                        <div>
                            <button class="list-btn btn-view" onclick="openReportInNewWindow('${data.fileData}')">View</button>
                            <a href="${data.fileData}" download="Report" class="list-btn btn-book" style="text-decoration:none; margin-left:5px;">Download</a>
                        </div>
                    `;
                    list.appendChild(div);
                });
            })
            .catch(error => {
                document.getElementById('myReportList').innerHTML = `<p style="color:red">Error loading reports: ${error.message}</p>`;
            });
    }

    // --- C. PATIENT: FIND DOCTOR ---
    function openFindDoctorModal() {
        modalContent.innerHTML = `
            <h2>Find a Specialist</h2>
            <div id="doctorListContainer" style="margin-top:20px;">Loading doctors...</div>
        `;
        modal.classList.add('active');
        loadDoctors();
    }

    async function loadDoctors() {
        const container = document.getElementById('doctorListContainer');
        
        let realDoctors = [];
        try {
            const docSnap = await db.collection('users').where('role', '==', 'doctor').get();
            docSnap.forEach(doc => realDoctors.push({ id: doc.id, ...doc.data() }));
        } catch (e) { 
            container.innerHTML = `<p style="color:red">Error connecting to database.</p>`;
            return;
        }

        let myApts = {};
        try {
            const aptSnap = await db.collection('appointments').where('patientId', '==', currentUserData.uid).get();
            aptSnap.forEach(doc => {
                const data = doc.data();
                myApts[data.doctorId] = { status: data.status, aptId: doc.id };
            });
        } catch (e) { console.log(e); }

        container.innerHTML = '';
        if (realDoctors.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <p>No doctors are currently registered.</p>
                    <small>Please register a new user as a 'Doctor' to test this.</small>
                </div>`;
            return;
        }

        realDoctors.forEach(doc => {
            const displayName = doc.name || "Unknown Doctor";
            const specialty = doc.special || "Specialist";
            
            let actionHtml = `<button class="list-btn btn-book" id="btn-${doc.id}" onclick="bookAppointment('${doc.id}', '${displayName}')">Book</button>`;
            
            if (myApts[doc.id]) {
                const aptInfo = myApts[doc.id];
                const status = aptInfo.status;

                if(status === 'accepted') {
                    actionHtml = `<button class="list-btn" style="background:var(--secondary); color:white; cursor:default">Approved</button>`;
                } else if (status === 'pending') {
                    actionHtml = `
                        <button class="list-btn" style="background:#F59E0B; color:white; cursor:default">Requested</button>
                        <button class="list-btn btn-cancel" onclick="cancelAppointment('${aptInfo.aptId}')">Cancel</button>
                    `;
                }
            }
            
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div>
                    <strong>${displayName}</strong><br>
                    <small style="color:gray">${specialty}</small>
                </div>
                <div>${actionHtml}</div>
            `;
            container.appendChild(div);
        });
    }

    function bookAppointment(docId, docName) {
        if (confirm(`Book appointment with ${docName}?`)) {
            db.collection('appointments').add({
                patientId: currentUserData.uid,
                patientName: currentUserData.name,
                doctorId: docId, 
                doctorName: docName,
                status: 'pending',
                requestDate: new Date().toISOString()
            }).then(() => {
                // FIXED: Removed success alert as requested
                loadDoctors(); 
            });
        }
    }

    // --- UPDATED: CANCEL LOGIC (Shared) ---
function cancelAppointment(aptId, role = 'patient') {
    if(confirm("Are you sure you want to cancel this appointment?")) {
        db.collection('appointments').doc(aptId).delete()
        .then(() => {
            if(role === 'doctor') {
                openAppointmentList('accepted'); // Refresh doctor view
            } else {
                loadDoctors(); // Refresh patient view
            }
        });
    }
}

    // --- D. DOCTOR: APPOINTMENTS ---
    // --- D. DOCTOR: APPOINTMENTS ---
function openAppointmentList(filterType) {
    const title = filterType === 'pending' ? 'Appointment Requests' : 'Confirmed Bookings';
    modalContent.innerHTML = `<h2>${title}</h2><div id="aptList">Loading...</div>`;
    modal.classList.add('active');

    db.collection('appointments')
        .where('doctorId', '==', currentUserData.uid)
        .get()
        .then(snap => {
            const list = document.getElementById('aptList');
            list.innerHTML = '';
            
            let count = 0;
            
            snap.forEach(doc => {
                const data = doc.data();
                if(data.status !== filterType) return; 
                count++;

                const div = document.createElement('div');
                div.className = 'list-item';
                
                let actionButtons = '';

                if(filterType === 'pending') {
                    actionButtons = `
                        <button id="btn-accept-${doc.id}" class="list-btn btn-accept" onclick="updateApt('${doc.id}', 'accepted')">Accept</button>
                        <button id="btn-decline-${doc.id}" class="list-btn btn-decline" onclick="updateApt('${doc.id}', 'declined')">Decline</button>
                    `;
                } else {
                    // --- UPDATED: Confirmed Bookings Actions ---
                    // 1. Clock Button (Set Time)
                    // 2. Open Profile
                    // 3. Cancel Button
                    
                    let timeDisplay = data.scheduledTime ? `<br><small style="color:var(--secondary)"><i class="fas fa-clock"></i> ${data.scheduledTime}</small>` : '';

                    actionButtons = `
                        <button class="list-btn btn-time" title="Set Time" onclick="openTimePicker('${doc.id}')"><i class="fas fa-clock"></i></button>
                        <button class="list-btn btn-book" onclick="openDoctorPatientView('${data.patientId}', '${data.patientName}')">Open Profile</button>
                        <button class="list-btn btn-cancel" onclick="cancelAppointment('${doc.id}', 'doctor')">Cancel</button>
                    `;
                    
                    // Add time to the left side info
                    div.dataset.hasTime = !!data.scheduledTime; // helper
                    if(data.scheduledTime) {
                        div.style.borderLeft = "4px solid var(--secondary)";
                    }
                }

                div.innerHTML = `
                    <div>
                        <strong>${data.patientName}</strong><br>
                        <small>${filterType === 'pending' ? 'Requested' : 'Booked'}: ${new Date(data.requestDate).toLocaleDateString()}</small>
                        ${data.scheduledTime ? `<br><small style="color:#2563EB; font-weight:600;"><i class="far fa-clock"></i> Time: ${data.scheduledTime}</small>` : ''}
                    </div>
                    <div style="text-align:right; display:flex; align-items:center; justify-content:flex-end;">
                        ${actionButtons}
                    </div>
                `;
                list.appendChild(div);
            });
            
            if(count === 0) list.innerHTML = `<p>No ${filterType} appointments found.</p>`;
        });
}



    function updateApt(aptId, status) {
        db.collection('appointments').doc(aptId).update({ status: status })
            .then(() => {
                if(status === 'accepted') {
                    const btn = document.getElementById(`btn-accept-${aptId}`);
                    const declineBtn = document.getElementById(`btn-decline-${aptId}`);
                    
                    if(btn) {
                        btn.innerText = "Accepted";
                        btn.disabled = true;
                        btn.style.opacity = "0.7";
                    }
                    if(declineBtn) declineBtn.style.display = 'none';
                } else {
                    const btn = document.getElementById(`btn-decline-${aptId}`);
                    if(btn) btn.innerText = "Declined";
                }
            })
            .catch(err => console.error(err));
    }

    // --- E. DOCTOR/PHARMACY: SEARCH PATIENT (REDESIGNED) ---
    function openPatientSearch() {
        modalContent.innerHTML = `
            <h2 style="margin-bottom:20px; text-align:center;">Patient Lookup</h2>
            
            <div class="modern-search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="pharmacySearchInput" class="search-input-field" placeholder="Search by patient name..." autocomplete="off">
                <button class="search-btn-modern" onclick="performSearch()">Search</button>
            </div>

            <div id="pharmacyResults" style="margin-top:20px; max-height: 400px; overflow-y:auto;"></div>
        `;
        modal.classList.add('active');
        // Auto-focus the input
        setTimeout(() => document.getElementById('pharmacySearchInput').focus(), 300);
    }

    function performSearch() {
        const query = document.getElementById('pharmacySearchInput').value.toLowerCase();
        const resultsDiv = document.getElementById('pharmacyResults');
        resultsDiv.innerHTML = '<div style="text-align:center; color:gray"><i class="fas fa-spinner fa-spin"></i> Searching database...</div>';

        db.collection('users').where('role', '==', 'patient').get().then(snap => {
            resultsDiv.innerHTML = '';
            let found = false;

            snap.forEach(doc => {
                const data = doc.data();
                const pName = (data.name || '').toLowerCase();
                
                if (pName.includes(query)) {
                    found = true;
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    
                    const btnAction = currentUserData.role === 'doctor' 
                        ? `openDoctorPatientView('${doc.id}', '${data.name}')`
                        : `openPharmacyPatientView('${doc.id}', '${data.name}')`;

                    div.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="background:#F3F4F6; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-user" style="color:#9CA3AF"></i>
                            </div>
                            <div>
                                <strong>${data.name}</strong><br><small style="font-size:0.75rem; color:#9CA3AF">ID: ${doc.id.substring(0,8)}...</small>
                            </div>
                        </div>
                        <button class="list-btn btn-view" onclick="${btnAction}">View Profile</button>
                    `;
                    resultsDiv.appendChild(div);
                }
            });
            if (!found) resultsDiv.innerHTML = `<p style="text-align:center; color:gray; padding:20px;">No patients found matching "${query}".</p>`;
        });
    }

    // --- F. DOCTOR: PATIENT PROFILE ---
    function openDoctorPatientView(patientId, patientName) {
        modalContent.innerHTML = `
            <h2>Patient: ${patientName}</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <button class="list-btn" onclick="loadPatientReports('${patientId}')" style="background:gray">Reports</button>
                <button class="list-btn btn-book" onclick="loadPatientPrescriptions('${patientId}', '${patientName}')">Prescriptions</button>
            </div>
            <div id="patientDetailContent">Loading...</div>
        `;
        loadPatientPrescriptions(patientId, patientName);
    }

    function loadPatientReports(patientId) {
        const container = document.getElementById('patientDetailContent');
        container.innerHTML = 'Loading Reports...';
        
        db.collection('reports').where('patientId', '==', patientId).get()
        .then(snap => {
            container.innerHTML = '';
            if (snap.empty) { container.innerHTML = '<p>No reports found for this patient.</p>'; return; }
            
            snap.forEach(doc => {
                const data = doc.data();
                container.innerHTML += `
                    <div class="list-item">
                        <span>${data.reportType}</span>
                        <div>
                             <button class="list-btn btn-view" onclick="openReportInNewWindow('${data.fileData}')">View</button>
                             <a href="${data.fileData}" download="Report" class="list-btn btn-book">Download</a>
                        </div>
                    </div>`;
            });
        })
        .catch(err => {
            container.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
        });
    }

    function loadPatientPrescriptions(patientId, patientName) {
        const container = document.getElementById('patientDetailContent');
        
        container.innerHTML = `
            <div style="background:#F3F4F6; padding:15px; border-radius:10px; margin-bottom:15px;">
                <h4>Add New Prescription</h4>
                <input type="text" id="rxMedicine" placeholder="Medicine Name" style="width:100%; margin:5px 0; padding:12px; border-radius:8px; border:1px solid #E5E7EB;">
                <input type="text" id="rxDosage" placeholder="Dosage (e.g., 1-0-1 after food)" style="width:100%; margin:5px 0; padding:12px; border-radius:8px; border:1px solid #E5E7EB;">
                <button class="list-btn btn-book" onclick="addPrescription('${patientId}', '${patientName}')" style="margin-top:10px;">Save Prescription</button>
            </div>
            
            <h4>Medical History (Prescriptions)</h4>
            <div id="rxHistory" style="margin-top:10px;">
                <p style="color:gray;">Loading history...</p> 
            </div>
        `;
        
        db.collection('prescriptions')
            .where('patientId', '==', patientId)
            .orderBy('timestamp', 'desc')
            .get()
            .then(snap => {
                const hist = document.getElementById('rxHistory');
                hist.innerHTML = ''; 
                
                if (snap.empty) { 
                    hist.innerHTML = '<p style="color:#6B7280; font-style:italic;">No previous prescriptions recorded.</p>'; 
                    return; 
                }
                
                snap.forEach(doc => {
                    const data = doc.data();
                    let dateStr = "Unknown Date";
                    if(data.timestamp) dateStr = new Date(data.timestamp.toDate()).toLocaleDateString();

                    hist.innerHTML += `
                        <div class="list-item" style="display:block; border-left: 4px solid var(--primary);">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${data.medicine}</strong>
                                <small style="color:gray;">${dateStr}</small>
                            </div>
                            <div style="color:#4B5563; font-size:0.9rem;">
                                ${data.dosage}
                            </div>
                            <div style="font-size:0.8rem; color:var(--primary); margin-top:4px;">
                                Prescribed by Dr. ${data.doctorName}
                            </div>
                        </div>`;
                });
            })
            .catch(err => {
                console.error(err);
                document.getElementById('rxHistory').innerHTML = `<p style="color:red">Error loading history.</p>`;
            });
    }

    function addPrescription(patientId, patientName) {
        const med = document.getElementById('rxMedicine').value;
        const dose = document.getElementById('rxDosage').value;
        if (!med || !dose) return alert("Fill all fields");
        
        db.collection('prescriptions').add({
            patientId: patientId,
            patientName: patientName,
            medicine: med,
            dosage: dose,
            doctorId: currentUserData.uid,
            doctorName: currentUserData.name,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            // FIXED: Removed success alert as requested
            loadPatientPrescriptions(patientId, patientName);
        });
    }

    // --- G. PHARMACY: VIEW PRESCRIPTIONS ---
    function openPharmacyPatientView(patientId, patientName) {
        modalContent.innerHTML = `
            <h2>Pharmacy: ${patientName}</h2>
            <p>Active Prescriptions</p>
            <div id="pharmRxList">Loading prescriptions...</div>
        `;
        
        db.collection('prescriptions')
            .where('patientId', '==', patientId)
            .get()
            .then(snap => {
                const list = document.getElementById('pharmRxList');
                list.innerHTML = '';
                if (snap.empty) { list.innerHTML = '<p>No prescriptions found.</p>'; return; }
                
                snap.forEach(doc => {
                    const data = doc.data();
                    list.innerHTML += `
                        <div class="list-item">
                            <div>
                                <strong>${data.medicine}</strong><br>
                                <small>${data.dosage}</small><br>
                                <small style="color:var(--primary)">Dr. ${data.doctorName}</small>
                            </div>
                            <button class="list-btn btn-accept" onclick="alert('Dispensing...')">Dispense</button>
                        </div>`;
                });
            })
            .catch(err => {
                 document.getElementById('pharmRxList').innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
            });
    }

    // --- H. UTILITIES ---
    function openReportInNewWindow(base64Data) {
        const win = window.open();
        if (win) {
            win.document.write('<iframe src="' + base64Data + '" frameborder="0" style="border:0; top:0; left:0; bottom:0; right:0; width:100%; height:100%;" allowfullscreen></iframe>');
        } else {
            alert("Please allow popups to view the report.");
        }
    }

    async function syncUserWithDB() {
        console.log("Syncing user identity...");
        const snap = await db.collection('users')
            .where('name', '==', currentUserData.name)
            .where('role', '==', currentUserData.role)
            .get();

        if (!snap.empty) {
            const doc = snap.docs[0];
            if (doc.id !== currentUserData.uid) {
                console.log("ID Mismatch. Switching to:", doc.id);
                currentUserData.uid = doc.id;
                localStorage.setItem('userUid', doc.id); 
            }
        } else {
            db.collection('users').doc(currentUserData.uid).set({
                name: currentUserData.name,
                role: currentUserData.role,
                special: 'General',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }
        
        if(currentUserData.role === 'doctor') openAppointmentList();
    }

    function logout() {
        auth.signOut().then(() => {
            localStorage.setItem('isLoggedIn', 'false');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userName');
            localStorage.removeItem('userUid');
            window.location.href = 'index.html';
        });
    }

    // --- NEW: PATIENT SCHEDULE VIEW ---
function openPatientSchedule() {
    modalContent.innerHTML = `<h2>My Schedule</h2><div id="scheduleList" style="margin-top:15px">Loading...</div>`;
    modal.classList.add('active');

    db.collection('appointments')
        .where('patientId', '==', currentUserData.uid)
        .where('status', '==', 'accepted')
        .get()
        .then(snap => {
            const list = document.getElementById('scheduleList');
            list.innerHTML = '';

            if (snap.empty) {
                list.innerHTML = '<p style="text-align:center; color:gray">No confirmed appointments yet.</p>';
                return;
            }

            snap.forEach(doc => {
                const data = doc.data();
                // Check if doctor has set a time
                const timeInfo = data.scheduledTime 
                    ? `<span style="color:#2563EB; font-weight:700; font-size:1.1rem;"><i class="far fa-clock"></i> ${data.scheduledTime}</span>` 
                    : `<span style="color:#F59E0B; font-style:italic;">Time not set by doctor yet</span>`;

                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div>
                        <strong>Dr. ${data.doctorName}</strong><br>
                        <small>Approved Date: ${new Date().toLocaleDateString()}</small>
                    </div>
                    <div style="text-align:right;">
                        ${timeInfo}
                    </div>
                `;
                list.appendChild(div);
            });
        });
}


// --- NEW: DOCTOR SET TIME LOGIC ---
function openTimePicker(aptId) {
    // We replace the modal content with a small form to set time
    modalContent.innerHTML = `
        <h3>Set Appointment Time</h3>
        <p style="color:gray; margin-bottom:15px;">Choose a time for this patient.</p>
        
        <div class="modal-form">
            <label>Select Date & Time</label>
            <input type="datetime-local" id="aptTimeInput">
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="list-btn btn-book" style="flex:1; padding:15px;" onclick="saveAppointmentTime('${aptId}')">Save Time</button>
                <button class="list-btn btn-cancel" style="flex:1; padding:15px;" onclick="openAppointmentList('accepted')">Back</button>
            </div>
        </div>
    `;
}

function saveAppointmentTime(aptId) {
    const timeVal = document.getElementById('aptTimeInput').value;
    if(!timeVal) return alert("Please select a time");

    // Format the date/time to look nice (e.g., "Oct 12, 10:30 AM")
    const dateObj = new Date(timeVal);
    const formattedTime = dateObj.toLocaleString('en-US', { 
        month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true 
    });

    db.collection('appointments').doc(aptId).update({
        scheduledTime: formattedTime,
        rawTime: timeVal // keep raw for sorting if needed later
    }).then(() => {
        // Return to list
        openAppointmentList('accepted');
    });
}
    </script>
</body>
</html>
