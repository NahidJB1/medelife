<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDeLIFE | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- SHARED VARIABLES (From Index) --- */
        :root {
            --primary: #EF4444;       
            --secondary: #22C55E;     
            --dark: #111827;          
            --gray: #6B7280;          
            --light: #F3F4F6;         
            --white: #ffffff;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: #F9FAFB; color: var(--dark); display: flex; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width); height: 100vh; background: var(--white);
            position: fixed; top: 0; left: 0; border-right: 1px solid #E5E7EB;
            display: flex; flex-direction: column; padding: 2rem 1.5rem;
            transition: all 0.3s ease; z-index: 100;
        }
        .brand {
            font-size: 24px; font-weight: 700; margin-bottom: 3rem; display: flex; align-items: center; gap: 10px; cursor: pointer;
        }
        .nav-items { flex: 1; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item {
            padding: 12px 15px; border-radius: 12px; color: var(--gray);
            font-weight: 500; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover, .nav-item.active { background: #FEF2F2; color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        
        .user-mini-profile {
            border-top: 1px solid #E5E7EB; padding-top: 1.5rem; display: flex; align-items: center; gap: 12px;
        }
        .mini-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--secondary); }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width));
            padding: 2rem 3rem; min-height: 100vh;
        }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
        .welcome-text h1 { font-size: 1.8rem; margin-bottom: 5px; animation: slideDown 0.5s ease-out; }
        .welcome-text p { color: var(--gray); animation: slideDown 0.7s ease-out; }
        
        .header-actions { display: flex; gap: 1rem; }
        .btn-logout { 
            padding: 10px 20px; border: 2px solid #FEE2E2; color: var(--primary); 
            background: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; 
        }
        .btn-logout:hover { background: #FEE2E2; }

        /* Dashboard Cards */
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 1.5rem; margin-bottom: 2.5rem; 
        }
        .stat-card {
            background: white; padding: 1.5rem; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #E5E7EB;
            display: flex; align-items: center; gap: 1.5rem;
            animation: fadeIn 0.8s ease-out backwards;
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--secondary); }
        
        .icon-box { 
            width: 60px; height: 60px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .icon-patient { background: #DCFCE7; color: var(--secondary); }
        .icon-doc { background: #FEE2E2; color: var(--primary); }
        
        .stat-info h3 { font-size: 2rem; font-weight: 700; line-height: 1.2; }
        .stat-info p { color: var(--gray); font-size: 0.9rem; }

        /* Role Specific Sections */
        .action-section { margin-bottom: 2rem; animation: slideUp 1s ease-out backwards; }
        .section-title { font-size: 1.2rem; margin-bottom: 1rem; font-weight: 600; }
        
        .quick-actions { display: flex; gap: 1rem; flex-wrap: wrap; }
        .action-card {
            flex: 1; min-width: 200px; background: white; padding: 2rem;
            border-radius: 16px; text-align: center; cursor: pointer;
            border: 2px dashed #E5E7EB; transition: all 0.3s;
        }
        .action-card:hover { border-color: var(--primary); background: #FEF2F2; }
        .action-card i { font-size: 2rem; color: var(--primary); margin-bottom: 1rem; }
        .action-card h4 { margin-bottom: 0.5rem; }
        .action-card p { font-size: 0.85rem; color: var(--gray); }

        /* Animations */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; padding: 1.5rem; }
        }

        /* --- ADD THIS TO YOUR CSS --- */
        
        /* Pharmacy Theme */
        .icon-pharmacy { background: #E0E7FF; color: #4F46E5; }
        
        /* Modal Styles (Reuse from Index but customized for Dashboard) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            z-index: 2000; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        
        .dashboard-modal {
            background: white; width: 90%; max-width: 600px;
            border-radius: 16px; padding: 2rem; position: relative;
            max-height: 85vh; overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            position: absolute; top: 15px; right: 20px; font-size: 1.5rem;
            cursor: pointer; color: var(--gray);
        }
        
        /* List Items for Doctors/Appointments */
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border: 1px solid #E5E7EB; border-radius: 10px;
            margin-bottom: 10px; transition: 0.2s;
        }
        .list-item:hover { border-color: var(--primary); background: #FEF2F2; }
        
        .list-btn {
            padding: 8px 16px; border-radius: 6px; border: none; 
            font-weight: 600; cursor: pointer; font-size: 0.85rem;
        }
        .btn-book { background: var(--primary); color: white; }
        .btn-view { background: #4F46E5; color: white; }
        .btn-accept { background: var(--secondary); color: white; margin-right: 5px;}
        .btn-decline { background: var(--primary); color: white; }

        /* Form Elements inside Modal */
        .modal-form label { display: block; margin-bottom: 8px; font-weight: 500; }
        .modal-form select, .modal-form input, .modal-form textarea {
            width: 100%; padding: 10px; border: 1px solid #E5E7EB; 
            border-radius: 8px; margin-bottom: 15px;
        }


    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="brand" onclick="window.location.href='index.html'">
            <svg width="30" height="30" viewBox="0 0 100 100" style="margin-right: 10px;">
                <rect x="35" y="10" width="30" height="80" rx="5" fill="#EF4444" />
                <rect x="10" y="35" width="80" height="30" rx="5" fill="#EF4444" />
            </svg>
            <span>MED<span style="color:var(--secondary)">e</span>LIFE</span>
        </div>

        <div class="nav-items" id="sidebarNav">
            </div>

        <div class="user-mini-profile">
            <img id="sideAvatar" src="https://via.placeholder.com/150" class="mini-avatar">
            <div>
                <h4 id="sideName" style="font-size: 0.9rem;">Loading...</h4>
                <p id="sideRole" style="font-size: 0.75rem; color: var(--gray);">...</p>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header>
            <div class="welcome-text">
                <h1 id="welcomeTitle">Welcome Back!</h1>
                <p id="currentDate">Loading date...</p>
            </div>
            <div class="header-actions">
                <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <div class="stats-grid" id="statsGrid">
            </div>

        <div class="action-section">
            <div class="section-title" id="actionTitle">Quick Actions</div>
            <div class="quick-actions" id="actionGrid">
                </div>
        </div>
    </main>

    <div class="modal-overlay" id="dashboardModal">
        <div class="dashboard-modal">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modalContent">
                </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
    // --- 0. FIREBASE SETUP ---
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUserData = null;
    const modal = document.getElementById('dashboardModal');
    const modalContent = document.getElementById('modalContent');

    // --- 1. INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
        initDashboard();
    });

    function initDashboard() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (!isLoggedIn) { window.location.href = 'index.html'; return; }

        const role = localStorage.getItem('userRole') || 'patient';
        const name = localStorage.getItem('userName') || 'User';

        // [CRITICAL FIX] Ensure ID stays the same across reloads
        let storedUid = localStorage.getItem('userUid');
        if (!storedUid) {
            // Generate ID once and keep it forever
            storedUid = 'user_' + Math.floor(Math.random() * 1000000);
            localStorage.setItem('userUid', storedUid);
        }

        currentUserData = {
            name: name,
            role: role,
            uid: storedUid
        };

        console.log("Logged in as:", currentUserData); // Debugging

        // UI Header
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', options);
        document.getElementById('welcomeTitle').innerHTML = `Welcome back, <span style="color: var(--primary)">${name}</span>`;
        document.getElementById('sideName').innerText = name;
        document.getElementById('sideRole').innerText = role.toUpperCase();

        // Load Avatar
        const savedJSON = localStorage.getItem('userProfileData');
        if (savedJSON) {
            const data = JSON.parse(savedJSON);
            if (data.photo) document.getElementById('sideAvatar').src = data.photo;
        }

        // ROUTING
        if (role === 'doctor') renderDoctorView();
        else if (role === 'pharmacy') renderPharmacyView();
        else renderPatientView();
    }

    function logout() {
        localStorage.removeItem('isLoggedIn');
        // Do NOT clear userUid so data persists for this browser
        window.location.href = 'index.html';
    }

    // --- 2. PATIENT VIEW ---
    function renderPatientView() {
        document.getElementById('sidebarNav').innerHTML = `
            <div class="nav-item active"><i class="fas fa-home"></i> Home</div>
            <div class="nav-item"><i class="fas fa-history"></i> Medical History</div>
            <div class="nav-item"><i class="fas fa-pills"></i> Prescriptions</div>
        `;

        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <div class="icon-box icon-patient"><i class="fas fa-heartbeat"></i></div>
                <div class="stat-info"><h3>Healthy</h3><p>Status</p></div>
            </div>
            <div class="stat-card">
                <div class="icon-box icon-doc"><i class="fas fa-file-medical-alt"></i></div>
                <div class="stat-info"><h3>Check</h3><p>My Reports</p></div>
            </div>
        `;

        // FIXED: Added specific IDs to buttons to ensure clicks work
        document.getElementById('actionGrid').innerHTML = `
            <div class="action-card" onclick="openUploadModal()">
                <i class="fas fa-file-upload"></i>
                <h4>Upload Report</h4>
                <p>X-Ray, ECG, etc.</p>
            </div>
            <div class="action-card" onclick="openFindDoctorModal()">
                <i class="fas fa-user-md"></i>
                <h4>Find Doctors</h4>
                <p>Book Appointment</p>
            </div>
            <div class="action-card" onclick="openMyReports()">
                <i class="fas fa-file-medical-alt"></i>
                <h4>My Reports</h4>
                <p>View History</p>
            </div>
        `;
    }

    // --- 3. DOCTOR VIEW ---
    function renderDoctorView() {
        document.getElementById('sidebarNav').innerHTML = `
            <div class="nav-item active"><i class="fas fa-th-large"></i> Dashboard</div>
            <div class="nav-item"><i class="fas fa-user-injured"></i> My Patients</div>
        `;

        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card" onclick="openAppointmentList()">
                <div class="icon-box icon-doc"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-info"><h3>Check</h3><p>Appointments</p></div>
            </div>
        `;

        document.getElementById('actionGrid').innerHTML = `
            <div class="action-card" onclick="openAppointmentList()">
                <i class="fas fa-clipboard-list"></i>
                <h4>View Bookings</h4>
                <p>Accept or Decline</p>
            </div>
            <div class="action-card" onclick="openPatientSearch()">
                <i class="fas fa-user-injured"></i>
                <h4>Find Patient</h4>
                <p>View History & Prescribe</p>
            </div>
        `;
    }

    // --- 4. PHARMACY VIEW ---
    function renderPharmacyView() {
        document.getElementById('sidebarNav').innerHTML = `
            <div class="nav-item active"><i class="fas fa-clinic-medical"></i> Dashboard</div>
            <div class="nav-item"><i class="fas fa-search"></i> Patient Lookup</div>
        `;

        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <div class="icon-box icon-pharmacy"><i class="fas fa-prescription-bottle"></i></div>
                <div class="stat-info"><h3>Rx</h3><p>Dispense</p></div>
            </div>
        `;

        document.getElementById('actionGrid').innerHTML = `
            <div class="action-card" onclick="openPatientSearch()">
                <i class="fas fa-search"></i>
                <h4>Search Patient</h4>
                <p>View Prescriptions</p>
            </div>
        `;
    }

    // ==========================================
    //        LOGIC FUNCTIONS (MODALS)
    // ==========================================

    function closeModal() {
        modal.classList.remove('active');
    }

    // --- A. PATIENT: UPLOAD REPORT ---
    function openUploadModal() {
        modalContent.innerHTML = `
            <h2><i class="fas fa-cloud-upload-alt" style="color:var(--primary)"></i> Upload Medical Report</h2>
            <div class="modal-form">
                <label>Report Type</label>
                <select id="reportType">
                    <option value="X-Ray">X-Ray</option>
                    <option value="ECG">ECG</option>
                    <option value="Blood Test">Blood Test</option>
                    <option value="Prescription">Old Prescription</option>
                </select>
                <label>Select File</label>
                <input type="file" id="reportFile" accept="image/*,.pdf">
                <button class="btn-login" style="width:100%" onclick="submitReport()">Upload Document</button>
            </div>
        `;
        modal.classList.add('active');
    }

    function submitReport() {
        const type = document.getElementById('reportType').value;
        const fileInput = document.getElementById('reportFile');

        if (fileInput.files.length === 0) { alert("Please select a file."); return; }

        // Show loading state
        document.querySelector('.btn-login').innerText = "Uploading...";

        const reader = new FileReader();
        reader.readAsDataURL(fileInput.files[0]);
        reader.onload = function () {
            const base64String = reader.result;
            db.collection('reports').add({
                patientId: currentUserData.uid,
                patientName: currentUserData.name,
                reportType: type,
                fileData: base64String,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Report Uploaded Successfully!");
                closeModal();
            }).catch(err => {
                alert("Error: " + err.message);
                closeModal();
            });
        };
    }

    // --- B. PATIENT: MY REPORTS (FIXED LOADING) ---
    function openMyReports() {
        modalContent.innerHTML = `<h2>My Medical Reports</h2><div id="myReportList" style="margin-top:15px">Loading your reports...</div>`;
        modal.classList.add('active');

        // Debug: Check which ID we are querying
        console.log("Fetching reports for ID:", currentUserData.uid);

        db.collection('reports')
            .where('patientId', '==', currentUserData.uid)
            .get()
            .then(snap => {
                const list = document.getElementById('myReportList');
                list.innerHTML = ''; // Clear "Loading" text

                if (snap.empty) {
                    list.innerHTML = `
                    <div style="text-align:center; color:gray; padding:20px;">
                        <i class="fas fa-folder-open" style="font-size:40px; margin-bottom:10px;"></i>
                        <p>No reports found.</p>
                        <small>Uploaded files will appear here.</small>
                    </div>`;
                    return;
                }

                snap.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div>
                            <strong>${data.reportType}</strong><br>
                            <small>${new Date().toLocaleDateString()}</small>
                        </div>
                        <a href="${data.fileData}" download="Report" class="list-btn btn-view" style="text-decoration:none; text-align:center;">Download</a>
                    `;
                    list.appendChild(div);
                });
            })
            .catch(error => {
                document.getElementById('myReportList').innerHTML = `<p style="color:red">Error loading reports: ${error.message}</p>`;
            });
    }

    // --- C. PATIENT: FIND DOCTOR (FIXED: REMOVED FAKE DOCTORS) ---
    function openFindDoctorModal() {
        modalContent.innerHTML = `
            <h2>Find a Specialist</h2>
            <div id="doctorListContainer" style="margin-top:20px;">Loading doctors...</div>
        `;
        modal.classList.add('active');
        loadDoctors();
    }

    async function loadDoctors() {
        const container = document.getElementById('doctorListContainer');
        
        // 1. Get ONLY Real Doctors from DB
        let realDoctors = [];
        try {
            const docSnap = await db.collection('users').where('role', '==', 'doctor').get();
            docSnap.forEach(doc => realDoctors.push({ id: doc.id, ...doc.data() }));
        } catch (e) { 
            container.innerHTML = `<p style="color:red">Error connecting to database.</p>`;
            return;
        }

        // 2. Get My Existing Appointments
        let myApts = {};
        try {
            const aptSnap = await db.collection('appointments').where('patientId', '==', currentUserData.uid).get();
            aptSnap.forEach(doc => {
                const data = doc.data();
                myApts[data.doctorId] = data.status;
            });
        } catch (e) { console.log(e); }

        container.innerHTML = '';
        if (realDoctors.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <p>No doctors are currently registered.</p>
                    <small>Please register a new user as a 'Doctor' to test this.</small>
                </div>`;
            return;
        }

        realDoctors.forEach(doc => {
            const displayName = doc.name || "Unknown Doctor";
            const specialty = doc.special || "Specialist";
            
            let btnHtml = `<button class="list-btn btn-book" id="btn-${doc.id}" onclick="bookAppointment('${doc.id}', '${displayName}')">Book</button>`;
            
            if (myApts[doc.id]) {
                const status = myApts[doc.id];
                let color = status === 'accepted' ? 'var(--secondary)' : '#F59E0B';
                let label = status === 'accepted' ? 'Approved' : 'Requested';
                btnHtml = `<button class="list-btn" style="background:${color}; color:white; cursor:default">${label}</button>`;
            }
            
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div>
                    <strong>${displayName}</strong><br>
                    <small style="color:gray">${specialty}</small>
                </div>
                ${btnHtml}
            `;
            container.appendChild(div);
        });
    }

    function bookAppointment(docId, docName) {
        if (confirm(`Book appointment with ${docName}?`)) {
            db.collection('appointments').add({
                patientId: currentUserData.uid,
                patientName: currentUserData.name,
                doctorId: docId, // This sends the request to the correct doctor
                doctorName: docName,
                status: 'pending',
                requestDate: new Date().toISOString()
            }).then(() => {
                const btn = document.getElementById(`btn-${docId}`);
                if (btn) {
                    btn.innerText = "Requested";
                    btn.style.background = "#F59E0B";
                    btn.onclick = null;
                }
            });
        }
    }

    // --- D. DOCTOR: APPOINTMENTS ---
    function openAppointmentList() {
        modalContent.innerHTML = `<h2>Incoming Appointments</h2><div id="aptList">Loading...</div>`;
        modal.classList.add('active');

        // Query appointments where doctorId matches THIS doctor
        db.collection('appointments')
            .where('doctorId', '==', currentUserData.uid)
            .get()
            .then(snap => {
                const list = document.getElementById('aptList');
                list.innerHTML = '';
                if (snap.empty) { list.innerHTML = '<p>No pending appointments.</p>'; return; }

                snap.forEach(doc => {
                    const data = doc.data();
                    // Filter locally if status is needed, or show all
                    if(data.status !== 'pending') return; 

                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div>
                            <strong>${data.patientName}</strong><br>
                            <small>Requested: ${new Date(data.requestDate).toLocaleDateString()}</small>
                        </div>
                        <div>
                            <button class="list-btn btn-accept" onclick="updateApt('${doc.id}', 'accepted')">Accept</button>
                            <button class="list-btn btn-decline" onclick="updateApt('${doc.id}', 'declined')">Decline</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                if(list.innerHTML === '') list.innerHTML = '<p>No pending appointments.</p>';
            });
    }

    function updateApt(aptId, status) {
        db.collection('appointments').doc(aptId).update({ status: status })
            .then(() => {
                alert("Appointment " + status);
                openAppointmentList();
            });
    }

    // --- E. DOCTOR/PHARMACY: SEARCH PATIENT (FIXED: ID PASSING) ---
    function openPatientSearch() {
        modalContent.innerHTML = `
            <h2>Patient Lookup</h2>
            <div class="modal-form">
                <input type="text" id="pharmacySearchInput" placeholder="Enter Patient Name...">
                <button class="btn-login" style="width:100%" onclick="performSearch()">Search</button>
            </div>
            <div id="pharmacyResults" style="margin-top:20px"></div>
        `;
        modal.classList.add('active');
    }

    function performSearch() {
        const query = document.getElementById('pharmacySearchInput').value.toLowerCase();
        const resultsDiv = document.getElementById('pharmacyResults');
        resultsDiv.innerHTML = 'Searching database...';

        db.collection('users').where('role', '==', 'patient').get().then(snap => {
            resultsDiv.innerHTML = '';
            let found = false;

            snap.forEach(doc => {
                const data = doc.data();
                const pName = (data.name || '').toLowerCase();
                
                if (pName.includes(query)) {
                    found = true;
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    
                    // PASS THE CORRECT ID HERE
                    const btnAction = currentUserData.role === 'doctor' 
                        ? `openDoctorPatientView('${doc.id}', '${data.name}')`
                        : `openPharmacyPatientView('${doc.id}', '${data.name}')`;

                    div.innerHTML = `
                        <div><strong>${data.name}</strong><br><small>ID: ${doc.id}</small></div>
                        <button class="list-btn btn-view" onclick="${btnAction}">View Profile</button>
                    `;
                    resultsDiv.appendChild(div);
                }
            });
            if (!found) resultsDiv.innerHTML = '<p>No patients found with that name.</p>';
        });
    }

    // --- F. DOCTOR: PATIENT PROFILE (FIXED TAB LOGIC) ---
    function openDoctorPatientView(patientId, patientName) {
        modalContent.innerHTML = `
            <h2>Patient: ${patientName}</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <button class="list-btn" onclick="loadPatientReports('${patientId}')" style="background:gray">Reports</button>
                <button class="list-btn btn-book" onclick="loadPatientPrescriptions('${patientId}', '${patientName}')">Prescriptions</button>
            </div>
            <div id="patientDetailContent">Loading...</div>
        `;
        // Load Prescriptions by default
        loadPatientPrescriptions(patientId, patientName);
    }

    function loadPatientReports(patientId) {
        const container = document.getElementById('patientDetailContent');
        container.innerHTML = 'Loading Reports...';
        
        db.collection('reports').where('patientId', '==', patientId).get().then(snap => {
            container.innerHTML = '';
            if (snap.empty) { container.innerHTML = '<p>No reports found for this patient.</p>'; return; }
            snap.forEach(doc => {
                const data = doc.data();
                container.innerHTML += `
                    <div class="list-item">
                        <span>${data.reportType}</span>
                        <a href="${data.fileData}" download="Report" class="list-btn btn-view">Download</a>
                    </div>`;
            });
        });
    }

    function loadPatientPrescriptions(patientId, patientName) {
        const container = document.getElementById('patientDetailContent');
        container.innerHTML = `
            <div style="background:#F3F4F6; padding:15px; border-radius:10px; margin-bottom:15px;">
                <h4>Add Prescription</h4>
                <input type="text" id="rxMedicine" placeholder="Medicine Name" style="width:100%; margin:5px 0; padding:8px;">
                <input type="text" id="rxDosage" placeholder="Dosage (e.g., 1-0-1 after food)" style="width:100%; margin:5px 0; padding:8px;">
                <button class="list-btn btn-book" onclick="addPrescription('${patientId}', '${patientName}')">Add Prescription</button>
            </div>
            <h4>History</h4>
            <div id="rxHistory">Loading history...</div>
        `;
        
        db.collection('prescriptions').where('patientId', '==', patientId).orderBy('timestamp', 'desc').get().then(snap => {
            const hist = document.getElementById('rxHistory');
            hist.innerHTML = '';
            if (snap.empty) { hist.innerHTML = '<p>No active prescriptions.</p>'; return; }
            snap.forEach(doc => {
                const data = doc.data();
                hist.innerHTML += `
                    <div class="list-item">
                        <div>
                            <strong>${data.medicine}</strong><br>
                            <small>${data.dosage} - Dr. ${data.doctorName}</small>
                        </div>
                    </div>`;
            });
        });
    }

    function addPrescription(patientId, patientName) {
        const med = document.getElementById('rxMedicine').value;
        const dose = document.getElementById('rxDosage').value;
        if (!med || !dose) return alert("Fill all fields");
        
        db.collection('prescriptions').add({
            patientId: patientId,
            patientName: patientName,
            medicine: med,
            dosage: dose,
            doctorId: currentUserData.uid,
            doctorName: currentUserData.name,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("Prescription Added");
            loadPatientPrescriptions(patientId, patientName);
        });
    }

    // --- G. PHARMACY: VIEW PRESCRIPTIONS (FIXED LOADING) ---
    function openPharmacyPatientView(patientId, patientName) {
        modalContent.innerHTML = `
            <h2>Pharmacy: ${patientName}</h2>
            <p>Active Prescriptions</p>
            <div id="pharmRxList">Loading prescriptions...</div>
        `;
        
        db.collection('prescriptions')
            .where('patientId', '==', patientId)
            .get()
            .then(snap => {
                const list = document.getElementById('pharmRxList');
                list.innerHTML = '';
                if (snap.empty) { list.innerHTML = '<p>No prescriptions found.</p>'; return; }
                
                snap.forEach(doc => {
                    const data = doc.data();
                    list.innerHTML += `
                        <div class="list-item">
                            <div>
                                <strong>${data.medicine}</strong><br>
                                <small>${data.dosage}</small><br>
                                <small style="color:var(--primary)">Dr. ${data.doctorName}</small>
                            </div>
                            <button class="list-btn btn-accept" onclick="alert('Dispensing...')">Dispense</button>
                        </div>`;
                });
            })
            .catch(err => {
                 document.getElementById('pharmRxList').innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
            });
    }
</script>
</body>
</html>
